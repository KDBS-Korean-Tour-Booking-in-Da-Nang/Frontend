# 3.2 Authentication Module

## 3.2.1 Sign In (Login With Email)

**Function Trigger:** The function is triggered when an unauthorized user accesses the landing page or navigates to the sign-in page.

**Screen Layout**

Figure 18 Login Screen

**Function Description:** The function allows users to authenticate using their email and password credentials. The system verifies that the provided credentials exist in the database and match an active account.

**Function Details:**

**Data:** Users can provide their credentials through:

- Email address (standard login form)
- Password (minimum 8 characters, no spaces allowed)

**Validation:**

- Email and password fields must not be empty
- Email must meet valid email format (e.g., user@example.com)
- Password must meet minimum length requirements (minimum 8 characters)
- For standard login, the provided credentials must match an existing account in the system
- The account associated with the credentials must be active (not UNVERIFIED or BANNED)
- Only USER and COMPANY roles can login via email (Staff/Admin must use username login)

**Business Rules:** BR-01

**Normal & Abnormal Cases:**

**Normal:**

- Credentials verified successfully
- A toast message is displayed: "Login successful"
- The user is redirected based on their role:
  - USER: Landing page
  - COMPANY/BUSINESS: Company dashboard
  - ADMIN/STAFF: Admin dashboard
- JWT token is generated and stored
- User session is established

**Abnormal:**

- Invalid or empty credentials entered
- Email not found in database
- Password does not match
- Account status is UNVERIFIED (email not verified)
- Account status is BANNED
- User role is STAFF or ADMIN (must use username login)
- A toast message is displayed with appropriate error: "Invalid login credentials", "Email không tồn tại", "Mật khẩu không đúng", etc.
- The user is not redirected to another page

---

## 3.2.2 Register

**Function Trigger:** The function is triggered when an unauthorized user navigates to the registration page or clicks the "Register Now" link from the login page.

**Screen Layout**

Figure 19 Register Screen

**Function Description:** The function allows new users to create an account by providing personal information and selecting their role (User or Business/Company). After registration, an OTP is automatically sent to the user's email for verification.

**Function Details:**

**Data:** Users can provide:

- Username (must start with a letter, can contain letters, digits, and spaces)
- Email address (must be unique and valid format)
- Password (minimum 8 characters, no spaces allowed)
- Confirm Password (must match password)
- Role selection (USER or BUSINESS/COMPANY)

**Validation:**

- Username must not be empty and must start with a letter
- Username cannot contain special characters (except spaces)
- Email must not be empty and must be valid format
- Email must be unique (not already registered)
- Password must be at least 8 characters long
- Confirm password must match password
- Password fields cannot contain spaces
- If email exists but status is UNVERIFIED and created within 3 days, user info is updated and OTP resent
- If email exists but status is UNVERIFIED and created more than 3 days ago, old user is deleted and new registration proceeds
- If username exists and belongs to UNVERIFIED user, old user is deleted
- If username exists and belongs to verified user, registration is blocked

**Business Rules:** BR-02

**Normal & Abnormal Cases:**

**Normal:**

- All fields validated successfully
- User account created with status UNVERIFIED
- OTP automatically sent to user's email
- A toast message is displayed: "Registration successful"
- User is redirected to email verification page
- Email and registration intent stored in localStorage

**Abnormal:**

- Empty or invalid username
- Username starts with number or contains special characters
- Empty or invalid email format
- Email already exists and is verified
- Password too short (less than 8 characters)
- Password and confirm password do not match
- Password contains spaces
- A toast message is displayed with appropriate error
- User remains on registration page

---

## 3.2.3 OAuth Login

**Function Trigger:** The function is triggered when a user clicks the "Login with Google" or "Login with Naver" button on the login page.

**Screen Layout**

Figure 20 OAuth Login Buttons

**Function Description:** The function allows users to authenticate using third-party OAuth providers (Google or Naver). The system redirects users to the provider's authentication page, and upon successful authentication, creates or updates the user account and grants access.

**Function Details:**

**Data:** Users authenticate through:

- Google OAuth2 (via Google account)
- Naver OAuth2 (via Naver account)

**Validation:**

- OAuth provider must be accessible
- Authorization code must be valid
- Access token exchange must succeed
- User info retrieval from provider must succeed
- For existing users, account is updated with latest avatar/username if missing
- For new users, account is created with default role USER and status UNBANNED

**Business Rules:** BR-03

**Normal & Abnormal Cases:**

**Normal:**

- User clicks OAuth button (Google or Naver)
- User is redirected to provider's authentication page
- User grants permissions
- Provider redirects back with authorization code
- System exchanges code for access token
- System retrieves user info from provider
- User account is created or updated
- JWT token is generated
- User is redirected to frontend callback page with token and user info
- User is automatically logged in
- A toast message is displayed: "Login successful"
- User is redirected based on role

**Abnormal:**

- OAuth provider is unavailable
- User denies permissions on provider page
- Authorization code is invalid or expired
- Access token exchange fails
- User info retrieval fails
- Network error during OAuth flow
- Error message is displayed in URL parameter or toast
- User remains on login page or is redirected to error page

---

## 3.2.4 Upload Company Information

**Function Trigger:** The function is triggered when a COMPANY role user with status COMPANY_PENDING or WAITING_FOR_APPROVAL navigates to the company onboarding page or uploads business license and ID card documents.

**Screen Layout**

Figure 21 Company Information Upload Screen

**Function Description:** The function allows company users to upload their business license document and ID card (front and back) for verification. The system processes the ID card using FPT AI API to extract information and stores all documents for admin review.

**Function Details:**

**Data:** Company users can provide:

- Business License file (PDF/image)
- ID Card front image
- ID Card back image
- User email (for identification)

**Validation:**

- User must have COMPANY role
- User must not have already uploaded business license (one-time upload)
- All three files must be provided (business license, ID card front, ID card back)
- Files must be valid image/PDF formats
- ID card front image is processed via FPT AI API to extract information
- Extracted ID card information is validated

**Business Rules:** BR-04

**Normal & Abnormal Cases:**

**Normal:**

- All three files uploaded successfully
- Business license file is stored
- ID card images are stored
- ID card information is extracted via FPT AI API
- User status changes to WAITING_FOR_APPROVAL
- A toast message is displayed: "Documents uploaded successfully"
- User is notified that documents are under review
- User can check upload status through the system interface

**Abnormal:**

- User already has business license uploaded
- Missing business license file
- Missing ID card front image
- Missing ID card back image
- Invalid file format
- FPT AI API fails to extract ID card information
- File upload fails
- A toast message is displayed with appropriate error
- User remains on upload page

---

## 3.2.5 Forgot Password

**Function Trigger:** The function is triggered when a user clicks the "Forgot Password" link on the login page or navigates to the forgot password page.

**Screen Layout**

Figure 22 Forgot Password Screen

**Function Description:** The function allows users to reset their password by requesting an OTP via email. After receiving the OTP, users can enter a new password to complete the reset process.

**Function Details:**

**Data:** Users can provide:

- Email address
- OTP code (received via email)
- New password
- Confirm new password

**Validation:**

- Email must exist in database
- Email must not be empty
- Account must not be BANNED
- OTP must be valid and not expired
- OTP purpose must be FORGOT_PASSWORD
- New password must meet minimum requirements (8 characters)
- New password and confirm password must match

**Business Rules:** BR-05

**Normal & Abnormal Cases:**

**Normal:**

- User enters email and requests OTP
- OTP is sent to user's email
- A toast message is displayed: "OTP sent successfully to your email"
- User enters OTP and new password
- OTP is verified
- Password is reset successfully
- Success email is sent to user
- A toast message is displayed: "Password reset successfully"
- User is redirected to login page

**Abnormal:**

- Email does not exist in database
- Email is empty or invalid format
- Account is BANNED
- OTP is invalid or expired
- OTP verification fails
- New password does not meet requirements
- New password and confirm password do not match
- A toast message is displayed with appropriate error
- User remains on forgot password page

---

## 3.2.6 Login With Username

**Function Trigger:** The function is triggered when STAFF or ADMIN users navigate to the staff/admin login page.

**Screen Layout**

Figure 23 Staff/Admin Login Screen

**Function Description:** The function allows STAFF and ADMIN users to authenticate using their username and password. This is a separate login flow from regular user login to ensure proper access control for administrative functions.

**Function Details:**

**Data:** Staff/Admin users can provide:

- Username (unique identifier)
- Password

**Validation:**

- Username and password fields must not be empty
- Username must exist in database
- Password must match the stored password
- User role must be STAFF or ADMIN (USER and COMPANY cannot use this login method)
- Account must be active (not BANNED)

**Business Rules:** BR-06

**Normal & Abnormal Cases:**

**Normal:**

- Credentials verified successfully
- A toast message is displayed: "Login successful"
- User is redirected to admin dashboard
- JWT token is generated and stored
- User session is established

**Abnormal:**

- Invalid or empty credentials entered
- Username does not exist
- Password does not match
- User role is USER or COMPANY (must use email login)
- Account is BANNED
- A toast message is displayed: "Invalid login credentials" or appropriate error message
- The user is not redirected to another page
